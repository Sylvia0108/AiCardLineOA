<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AiCard - ç”¨æˆ¶è³‡æ–™ç®¡ç†</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
        transition: background 0.3s;
      }

      .btn:hover {
        background: #5a6fd8;
      }

      .btn-danger {
        background: #e74c3c;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
      }

      .user-list {
        display: grid;
        gap: 15px;
      }

      .user-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-info h3 {
        margin-bottom: 5px;
        color: #333;
      }

      .user-info p {
        color: #666;
        font-size: 14px;
        margin: 2px 0;
      }

      .loading {
        text-align: center;
        padding: 40px;
        font-size: 18px;
        color: #666;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .json-viewer {
        background: #2d3748;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 14px;
        overflow-x: auto;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }

      .auto-refresh {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .button-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .refresh-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #28a745;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ—„ï¸ AiCard ç”¨æˆ¶è³‡æ–™ç®¡ç†</h1>
        <p>å³æ™‚æŸ¥çœ‹å’Œç®¡ç† userDatabase ä¸­çš„æ‰€æœ‰ç”¨æˆ¶è³‡æ–™</p>
        <div class="auto-refresh">
          <span>è‡ªå‹•åˆ·æ–°</span>
          <div class="refresh-indicator"></div>
          <span id="lastUpdate">è¼‰å…¥ä¸­...</span>
        </div>
      </div>

      <div id="message"></div>

      <div class="card">
        <h2>ğŸ“Š ä¼ºæœå™¨çµ±è¨ˆ</h2>
        <div class="stats" id="serverStats">
          <div class="loading">è¼‰å…¥çµ±è¨ˆè³‡æ–™ä¸­...</div>
        </div>
      </div>

      <div class="card">
        <div class="button-container">
          <h2>ğŸ‘¥ ç”¨æˆ¶åˆ—è¡¨</h2>
          <div>
            <button type="button" class="btn" onclick="refreshData()">
              ğŸ”„ æ‰‹å‹•åˆ·æ–°
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="clearDatabase()"
            >
              ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™åº«
            </button>
          </div>
        </div>
        <div id="userList">
          <div class="loading">è¼‰å…¥ç”¨æˆ¶è³‡æ–™ä¸­...</div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“‹ åŸå§‹JSONè³‡æ–™</h2>
        <div id="jsonData" class="json-viewer">è¼‰å…¥ä¸­...</div>
      </div>
    </div>

    <script>
      let autoRefreshInterval;

      async function fetchData(endpoint) {
        try {
          const response = await fetch(`/api${endpoint}`);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return await response.json();
        } catch (error) {
          throw new Error(`API è«‹æ±‚å¤±æ•—: ${error.message}`);
        }
      }

      function showMessage(message, type = "success") {
        const messageDiv = document.getElementById("message");
        messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
        setTimeout(() => {
          messageDiv.innerHTML = "";
        }, 3000);
      }

      function formatTime(dateString) {
        return new Date(dateString).toLocaleString("zh-TW");
      }

      function formatUptime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        return `${hours}æ™‚${minutes}åˆ†${secs}ç§’`;
      }

      function formatBytes(bytes) {
        const sizes = ["Bytes", "KB", "MB", "GB"];
        if (bytes === 0) return "0 Bytes";
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return (
          Math.round((bytes / Math.pow(1024, i)) * 100) / 100 + " " + sizes[i]
        );
      }

      async function loadServerStats() {
        try {
          const stats = await fetchData("/status");
          const statsHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${stats.totalUsers}</div>
                        <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${formatUptime(
                          stats.uptime
                        )}</div>
                        <div class="stat-label">é‹è¡Œæ™‚é–“</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${formatBytes(
                          stats.memoryUsage.heapUsed
                        )}</div>
                        <div class="stat-label">è¨˜æ†¶é«”ä½¿ç”¨</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${
                          stats.lastRegistration
                            ? formatTime(stats.lastRegistration)
                            : "ç„¡"
                        }</div>
                        <div class="stat-label">æœ€å¾Œè¨»å†Šæ™‚é–“</div>
                    </div>
                `;
          document.getElementById("serverStats").innerHTML = statsHTML;
        } catch (error) {
          document.getElementById(
            "serverStats"
          ).innerHTML = `<div class="error">è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—: ${error.message}</div>`;
        }
      }

      async function loadUsers() {
        try {
          const data = await fetchData("/users");
          const userListDiv = document.getElementById("userList");
          const jsonDataDiv = document.getElementById("jsonData");

          if (data.users.length === 0) {
            userListDiv.innerHTML =
              '<div class="loading">ğŸ“­ ç›®å‰æ²’æœ‰ç”¨æˆ¶è³‡æ–™</div>';
          } else {
            const usersHTML = data.users
              .map(
                (user) => `
                        <div class="user-item">
                            <div class="user-info">
                                <h3>ğŸ‘¤ ${user.displayName}</h3>
                                <p><strong>ç”¨æˆ¶ID:</strong> ${user.userId}</p>
                                <p><strong>è¨»å†Šæ™‚é–“:</strong> ${formatTime(
                                  user.registeredAt
                                )}</p>
                            </div>
                            <button class="btn" onclick="viewUser('${
                              user.userId
                            }')">ğŸ“„ æŸ¥çœ‹è©³æƒ…</button>
                        </div>
                    `
              )
              .join("");
            userListDiv.innerHTML = usersHTML;
          }

          // é¡¯ç¤ºåŸå§‹JSON
          jsonDataDiv.textContent = JSON.stringify(data, null, 2);

          // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
          document.getElementById("lastUpdate").textContent =
            "æœ€å¾Œæ›´æ–°: " + new Date().toLocaleTimeString("zh-TW");
        } catch (error) {
          document.getElementById(
            "userList"
          ).innerHTML = `<div class="error">è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—: ${error.message}</div>`;
          document.getElementById(
            "jsonData"
          ).textContent = `éŒ¯èª¤: ${error.message}`;
        }
      }

      async function viewUser(userId) {
        try {
          const user = await fetchData(`/users/${userId}`);
          alert(`ç”¨æˆ¶è©³ç´°è³‡æ–™:\n\n${JSON.stringify(user, null, 2)}`);
        } catch (error) {
          showMessage(`æŸ¥çœ‹ç”¨æˆ¶å¤±æ•—: ${error.message}`, "error");
        }
      }

      async function clearDatabase() {
        if (!confirm("âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç”¨æˆ¶è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) {
          return;
        }

        try {
          const response = await fetch("/api/users", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          showMessage(`âœ… ${result.message}`, "success");
          refreshData();
        } catch (error) {
          showMessage(`æ¸…ç©ºè³‡æ–™åº«å¤±æ•—: ${error.message}`, "error");
        }
      }

      async function refreshData() {
        await Promise.all([loadServerStats(), loadUsers()]);
      }

      function startAutoRefresh() {
        // æ¯5ç§’è‡ªå‹•åˆ·æ–°
        autoRefreshInterval = setInterval(refreshData, 5000);
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }
      }

      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        refreshData();
        startAutoRefresh();
      });

      // é é¢å¸è¼‰æ™‚åœæ­¢è‡ªå‹•åˆ·æ–°
      window.addEventListener("beforeunload", stopAutoRefresh);

      // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚æ§åˆ¶è‡ªå‹•åˆ·æ–°
      document.addEventListener("visibilitychange", function () {
        if (document.hidden) {
          stopAutoRefresh();
        } else {
          startAutoRefresh();
          refreshData();
        }
      });
    </script>
  </body>
</html>
