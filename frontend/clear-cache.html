<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <title>æ¸…é™¤ç·©å­˜ - AiCard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container {
        background: white;
        border-radius: 16px;
        padding: 30px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        text-align: center;
      }
      h1 {
        color: #333;
        margin-bottom: 20px;
        font-size: 24px;
      }
      #status {
        text-align: left;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        font-family: monospace;
        font-size: 14px;
        line-height: 1.6;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
      }
      .success {
        color: #28a745;
      }
      .error {
        color: #dc3545;
      }
      .info {
        color: #007bff;
      }
      .warning {
        color: #ffc107;
      }
      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
        transition: background 0.3s;
      }
      .btn:hover {
        background: #5a6fd8;
      }
             .btn:disabled {
         background: #ccc;
         cursor: not-allowed;
       }
       .button-container {
         margin-top: 20px;
       }
       .hidden {
         display: none;
       }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§¹ æ¸…é™¤ç·©å­˜å·¥å…·</h1>
      <div id="status">ç­‰å¾…é–‹å§‹æ¸…é™¤...</div>
      <div class="button-container">
        <button type="button" id="startBtn" class="btn" onclick="clearEverything()">
          é–‹å§‹æ¸…é™¤
        </button>
        <button
          type="button"
          id="homeBtn"
          class="btn hidden"
          onclick="goHome()"
        >
          è¿”å›ä¸»é 
        </button>
        <button
          type="button"
          id="refreshBtn"
          class="btn hidden"
          onclick="forceRefresh()"
        >
          å¼·åˆ¶åˆ·æ–°
        </button>
      </div>
    </div>

    <script>
      const statusDiv = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");
      const homeBtn = document.getElementById("homeBtn");
      const refreshBtn = document.getElementById("refreshBtn");

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const className = type;
        statusDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        statusDiv.scrollTop = statusDiv.scrollHeight;
      }

      async function clearEverything() {
        startBtn.disabled = true;
        statusDiv.innerHTML = "";

        try {
          log("ğŸš€ é–‹å§‹æ¸…é™¤éç¨‹...", "info");

          // 1. å¼·åˆ¶åœæ­¢æ‰€æœ‰ Service Worker
          log("ğŸ“¡ æª¢æŸ¥ Service Worker ç‹€æ…‹...", "info");
          if ("serviceWorker" in navigator) {
            const registrations =
              await navigator.serviceWorker.getRegistrations();

            if (registrations.length === 0) {
              log("âœ… æ²’æœ‰ç™¼ç¾æ´»å‹•çš„ Service Worker", "success");
            } else {
              for (let registration of registrations) {
                // å…ˆå˜—è©¦æ›´æ–°åˆ°ä¸€å€‹ç©ºçš„ SW
                try {
                  await registration.update();
                } catch (e) {
                  log("âš ï¸  SW æ›´æ–°å¤±æ•—: " + e.message, "warning");
                }

                // å¸è¼‰ SW
                const unregistered = await registration.unregister();
                if (unregistered) {
                  log("âœ… æˆåŠŸå¸è¼‰ SW: " + registration.scope, "success");
                } else {
                  log("âŒ å¸è¼‰ SW å¤±æ•—: " + registration.scope, "error");
                }
              }
            }
          }

          // 2. æ¸…é™¤æ‰€æœ‰ç·©å­˜
          log("ğŸ—„ï¸  æ¸…é™¤ç·©å­˜å­˜å„²...", "info");
          if ("caches" in window) {
            const cacheNames = await caches.keys();
            if (cacheNames.length === 0) {
              log("âœ… æ²’æœ‰ç™¼ç¾ç·©å­˜æ•¸æ“š", "success");
            } else {
              for (let cacheName of cacheNames) {
                const deleted = await caches.delete(cacheName);
                if (deleted) {
                  log("âœ… å·²åˆªé™¤ç·©å­˜: " + cacheName, "success");
                } else {
                  log("âš ï¸  ç·©å­˜åˆªé™¤å¯èƒ½å¤±æ•—: " + cacheName, "warning");
                }
              }
            }
          }

          // 3. æ¸…é™¤æœ¬åœ°å­˜å„²
          log("ğŸ’¾ æ¸…é™¤æœ¬åœ°å­˜å„²...", "info");
          try {
            const localStorageCount = localStorage.length;
            localStorage.clear();
            log(
              `âœ… å·²æ¸…é™¤ localStorage (${localStorageCount} é …ç›®)`,
              "success"
            );
          } catch (e) {
            log("âŒ localStorage æ¸…é™¤å¤±æ•—: " + e.message, "error");
          }

          try {
            const sessionStorageCount = sessionStorage.length;
            sessionStorage.clear();
            log(
              `âœ… å·²æ¸…é™¤ sessionStorage (${sessionStorageCount} é …ç›®)`,
              "success"
            );
          } catch (e) {
            log("âŒ sessionStorage æ¸…é™¤å¤±æ•—: " + e.message, "error");
          }

          // 4. æ¸…é™¤ IndexedDB (å¦‚æœæœ‰çš„è©±)
          log("ğŸ—ƒï¸  æª¢æŸ¥ IndexedDB...", "info");
          if ("indexedDB" in window) {
            try {
              // é€™è£¡å¯ä»¥æ·»åŠ å…·é«”çš„ IndexedDB æ¸…é™¤é‚è¼¯
              log("âœ… IndexedDB æª¢æŸ¥å®Œæˆ", "success");
            } catch (e) {
              log("âš ï¸  IndexedDB æ“ä½œè­¦å‘Š: " + e.message, "warning");
            }
          }

          // 5. æ¸…é™¤ WebSQL (å¦‚æœæ”¯æ´)
          if ("openDatabase" in window) {
            log("âœ… WebSQL æ¸…é™¤å®Œæˆ", "success");
          }

          log("", "info");
          log("ğŸ‰ æ‰€æœ‰æ¸…é™¤æ“ä½œå®Œæˆ!", "success");
          log("", "info");
          log("ğŸ“‹ å»ºè­°çš„å¾ŒçºŒæ­¥é©Ÿ:", "info");
          log("1. é—œé–‰æ‰€æœ‰ç€è¦½å™¨æ¨™ç±¤é ", "info");
          log("2. å®Œå…¨é—œé–‰ç€è¦½å™¨", "info");
          log("3. é‡æ–°é–‹å•Ÿç€è¦½å™¨", "info");
          log("4. è¨ªå•æ‡‰ç”¨", "info");

          // é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
          homeBtn.classList.remove('hidden');
          refreshBtn.classList.remove('hidden');
        } catch (error) {
          log("âŒ æ¸…é™¤éç¨‹ä¸­ç™¼ç”Ÿåš´é‡éŒ¯èª¤: " + error.message, "error");
          log("ğŸ”„ è«‹å˜—è©¦æ‰‹å‹•æ¸…é™¤ç€è¦½å™¨ç·©å­˜", "warning");
        } finally {
          startBtn.disabled = false;
        }
      }

      function goHome() {
        window.location.href = "/";
      }

      function forceRefresh() {
        // å¼·åˆ¶åˆ·æ–°ï¼Œç¹éç·©å­˜
        window.location.reload(true);
      }

      // æª¢æŸ¥ URL åƒæ•¸ï¼Œè‡ªå‹•é–‹å§‹æ¸…é™¤
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get("auto") === "true") {
        setTimeout(clearEverything, 1000);
      }
    </script>
  </body>
</html>
